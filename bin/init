#!/usr/bin/env node

var Metalsmith = require("metalsmith");
var markdown = require("metalsmith-markdown");
var templates = require("metalsmith-templates");
var each = require("metalsmith-each");
var collections = require("metalsmith-collections");
var iconvlite = require("iconv-lite");

console.log("Generating static content using Metalsmith...");

var metalsmith = Metalsmith(__dirname + "/../");

metalsmith.use(collections({
        blogposts: {
            sortBy: 'date',
            reverse: true
        }
    }))
    .use(each(function (file, filename) {
        file.url = filename.substring(0, filename.lastIndexOf("/"));
    }))
    .use(each(function (file, filename) {
        if (filename == "blogg/index.md") {
            var content = file.contents.toString();
            for (var i=0; i<metalsmith.metadata().blogposts.length; i++) {
                var blogpost = metalsmith.metadata().blogposts[i];
                content += "\n+ [" + blogpost.title + "](/" + blogpost.url + ")";
            }
            file.contents = new Buffer(content);
        }

        if (filename == "projekt/hjelmsby/gardar/index.md") {
            var content = file.contents.toString();
            for (var i=0; i<metalsmith.metadata().projekt_hjelmsby_gardar.length; i++) {
                var page = metalsmith.metadata().projekt_hjelmsby_gardar[i];
                content += "\n+ [" + page.title + "](/" + page.url + ")";
            }
            file.contents = new Buffer(content);
        }

        if (filename == "projekt/hjelmsby/kvarnar/index.md") {
            var content = file.contents.toString();
            for (var i=0; i<metalsmith.metadata().projekt_hjelmsby_kvarnar.length; i++) {
                var page = metalsmith.metadata().projekt_hjelmsby_kvarnar[i];
                content += "\n+ [" + page.title + "](/" + page.url + ")";
            }
            file.contents = new Buffer(content);
        }

        if (filename == "projekt/hjelmsby/orter/index.md") {
            var content = file.contents.toString();
            for (var i=0; i<metalsmith.metadata().projekt_hjelmsby_orter.length; i++) {
                var page = metalsmith.metadata().projekt_hjelmsby_orter[i];
                content += "\n+ [" + page.title + "](/" + page.url + ")";
            }
            file.contents = new Buffer(content);
        }

        if (filename == "projekt/hjelmsby/personer/index.md") {
            var content = file.contents.toString();
            for (var i=0; i<metalsmith.metadata().projekt_hjelmsby_personer.length; i++) {
                var page = metalsmith.metadata().projekt_hjelmsby_personer[i];
                content += "\n+ [" + page.title + "](/" + page.url + ")";
            }
            file.contents = new Buffer(content);
        }

        if (filename == "projekt/hjelmsby/stugor/index.md") {
            var content = file.contents.toString();
            for (var i=0; i<metalsmith.metadata().projekt_hjelmsby_stugor.length; i++) {
                var page = metalsmith.metadata().projekt_hjelmsby_stugor[i];
                content += "\n+ [" + page.title + "](/" + page.url + ")";
            }
            file.contents = new Buffer(content);
        }

        if (filename == "projekt/hjelmsby/torp/index.md") {
            var content = file.contents.toString();
            for (var i=0; i<metalsmith.metadata().projekt_hjelmsby_torp.length; i++) {
                var page = metalsmith.metadata().projekt_hjelmsby_torp[i];
                content += "\n+ [" + page.title + "](/" + page.url + ")";
            }
            file.contents = new Buffer(content);
        }
    }))
    .use(markdown())
    .use(templates({
        engine: "handlebars",
        directory: "./templates"
    }))
    .destination("./public")
    .build(function (err) {
        if (err) {
            console.log(err);
        }
        else {
            console.log("Metalsmith finished successfully.");
        }
    });