#!/usr/bin/env iojs

var Metalsmith = require("metalsmith");
var markdown = require("metalsmith-markdown");
var templates = require("metalsmith-templates");
var each = require("metalsmith-each");
var collections = require("metalsmith-collections");
var iconvlite = require("iconv-lite");
var jquery = require("jquery");
var env = require('jsdom').env;

console.log("Generating static content using Metalsmith...");

var metalsmith = Metalsmith(__dirname + "/../");

metalsmith.use(collections({
        blogposts: {
            sortBy: 'date',
            reverse: true
        }
    }))
    .use(each(function (file, filename) {
        file.url = filename.substring(0, filename.lastIndexOf("/"));
    }))
    .use(each(function (file, filename) {
        if (filename === "blogg/index.md") {
            var content = file.contents.toString();
            for (var i=0; i<metalsmith.metadata().blogposts.length; i++) {
                var blogpost = metalsmith.metadata().blogposts[i];
                content += "\n+ [" + blogpost.title + "](/" + blogpost.url + ")";
            }
            file.contents = new Buffer(content);
        }

        if (filename === "projekt/hjelmsby/gardar/index.md") {
            var content = file.contents.toString();
            for (var i=0; i<metalsmith.metadata().projekt_hjelmsby_gardar.length; i++) {
                var page = metalsmith.metadata().projekt_hjelmsby_gardar[i];
                content += "\n+ [" + page.title + "](/" + page.url + ")";
            }
            file.contents = new Buffer(content);
        }

        if (filename === "projekt/hjelmsby/kvarnar/index.md") {
            var content = file.contents.toString();
            for (var i=0; i<metalsmith.metadata().projekt_hjelmsby_kvarnar.length; i++) {
                var page = metalsmith.metadata().projekt_hjelmsby_kvarnar[i];
                content += "\n+ [" + page.title + "](/" + page.url + ")";
            }
            file.contents = new Buffer(content);
        }

        if (filename === "projekt/hjelmsby/orter/index.md") {
            var content = file.contents.toString();
            for (var i=0; i<metalsmith.metadata().projekt_hjelmsby_orter.length; i++) {
                var page = metalsmith.metadata().projekt_hjelmsby_orter[i];
                content += "\n+ [" + page.title + "](/" + page.url + ")";
            }
            file.contents = new Buffer(content);
        }

        if (filename === "projekt/hjelmsby/personer/index.md") {
            var content = file.contents.toString();
            for (var i=0; i<metalsmith.metadata().projekt_hjelmsby_personer.length; i++) {
                var page = metalsmith.metadata().projekt_hjelmsby_personer[i];
                content += "\n+ [" + page.title + "](/" + page.url + ")";
            }
            file.contents = new Buffer(content);
        }

        if (filename === "projekt/hjelmsby/stugor/index.md") {
            var content = file.contents.toString();
            for (var i=0; i<metalsmith.metadata().projekt_hjelmsby_stugor.length; i++) {
                var page = metalsmith.metadata().projekt_hjelmsby_stugor[i];
                content += "\n+ [" + page.title + "](/" + page.url + ")";
            }
            file.contents = new Buffer(content);
        }

        if (filename === "projekt/hjelmsby/torp/index.md") {
            var content = file.contents.toString();
            for (var i=0; i<metalsmith.metadata().projekt_hjelmsby_torp.length; i++) {
                var page = metalsmith.metadata().projekt_hjelmsby_torp[i];
                content += "\n+ [" + page.title + "](/" + page.url + ")";
            }
            file.contents = new Buffer(content);
        }
    }))
    .use(markdown())
    .use(templates({
        engine: "handlebars",
        directory: "./templates"
    }))
    .use(each(function (file, filename, done) {
        env(file.contents.toString(), function (errors, window) {
            if (errors) console.log(errors);
            var $ = jquery(window);

            $(".img-responsive-sizes").each(function (index) {
                var img = $(this);
                img.removeClass("img-responsive-sizes");
                img.addClass("b-lazy");

                var flickrVars = img.attr("src").split(",");

                // https://farm9.staticflickr.com/8636/16449826650_b6928018bd_q.jpg

                img.attr("src", "data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==");
                img.attr("data-src-small", "https://" + flickrVars[0] + ".staticflickr.com/" + flickrVars[1] + "/" + flickrVars[2] + "_" + flickrVars[3] + ".jpg");
                img.attr("data-src-medium", "https://" + flickrVars[0] + ".staticflickr.com/" + flickrVars[1] + "/" + flickrVars[2] + "_" + flickrVars[3] + "_b.jpg");
                img.attr("data-src-large", "https://" + flickrVars[0] + ".staticflickr.com/" + flickrVars[1] + "/" + flickrVars[2] + "_" + flickrVars[4] + "_k.jpg");
            });

            /*$(".bg-responsive-sizes").each(function (index) {
                var obj = $(this);
                obj.removeClass("bg-responsive-sizes");
                img.addClass("b-lazy");
            });*/

            file.contents = new Buffer("<html>" + $("html").html() + "</html>");

            done();
        });
    }))
    .destination("./public")
    .build(function (err) {
        if (err) {
            console.log(err);
        }
        else {
            console.log("Metalsmith finished successfully.");
        }
    });