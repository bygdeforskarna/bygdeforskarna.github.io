#!/usr/bin/env node

var Metalsmith = require("metalsmith");
var markdown = require("metalsmith-markdown");
var layouts = require("metalsmith-layouts");
var each = require("metalsmith-each");
var collections = require("metalsmith-collections");
var iconvlite = require("iconv-lite");
var jquery = require("jquery");
var env = require("jsdom").env;

console.log("Generating static content using Metalsmith...");

var metalsmith = Metalsmith(__dirname + "/../");

metalsmith
    .clean(false)
    .use(collections({
        blogposts: {
            sortBy: 'date',
            reverse: true
        }
    }))
    .use(each(function (file, filename) {
        var urlDelimiter = "/";
        if (filename.lastIndexOf("/") == -1) { // Shiiieeeet, we are on Windows or similar.
            urlDelimiter = "\\";
        }
        file.url = filename.substring(0, filename.lastIndexOf(urlDelimiter));
    }))
    .use(each(function (file, filename) {
        if (filename === "projekt/hjelmsby/gardar/index.md") {
            var content = file.contents.toString();
            for (var i=0; i<metalsmith.metadata().projekt_hjelmsby_gardar.length; i++) {
                var page = metalsmith.metadata().projekt_hjelmsby_gardar[i];
                content += "\n+ [" + page.title + "](/" + page.url + ")";
            }
            file.contents = new Buffer(content);
        }

        if (filename === "projekt/hjelmsby/kvarnar/index.md") {
            var content = file.contents.toString();
            for (var i=0; i<metalsmith.metadata().projekt_hjelmsby_kvarnar.length; i++) {
                var page = metalsmith.metadata().projekt_hjelmsby_kvarnar[i];
                content += "\n+ [" + page.title + "](/" + page.url + ")";
            }
            file.contents = new Buffer(content);
        }

        if (filename === "projekt/hjelmsby/orter/index.md") {
            var content = file.contents.toString();
            for (var i=0; i<metalsmith.metadata().projekt_hjelmsby_orter.length; i++) {
                var page = metalsmith.metadata().projekt_hjelmsby_orter[i];
                content += "\n+ [" + page.title + "](/" + page.url + ")";
            }
            file.contents = new Buffer(content);
        }

        if (filename === "projekt/hjelmsby/personer/index.md") {
            var content = file.contents.toString();
            for (var i=0; i<metalsmith.metadata().projekt_hjelmsby_personer.length; i++) {
                var page = metalsmith.metadata().projekt_hjelmsby_personer[i];
                content += "\n+ [" + page.title + "](/" + page.url + ")";
            }
            file.contents = new Buffer(content);
        }

        if (filename === "projekt/hjelmsby/stugor/index.md") {
            var content = file.contents.toString();
            for (var i=0; i<metalsmith.metadata().projekt_hjelmsby_stugor.length; i++) {
                var page = metalsmith.metadata().projekt_hjelmsby_stugor[i];
                content += "\n+ [" + page.title + "](/" + page.url + ")";
            }
            file.contents = new Buffer(content);
        }

        if (filename === "projekt/hjelmsby/torp/index.md") {
            var content = file.contents.toString();
            for (var i=0; i<metalsmith.metadata().projekt_hjelmsby_torp.length; i++) {
                var page = metalsmith.metadata().projekt_hjelmsby_torp[i];
                content += "\n+ [" + page.title + "](/" + page.url + ")";
            }
            file.contents = new Buffer(content);
        }
    }))
    .use(markdown())
    .use(layouts({
        engine: "handlebars"
    }))
    .use(each(function (file, filename, done) {
        env(file.contents.toString(), function (errors, window) {
            if (errors) console.log(errors);
            var $ = jquery(window);


            if (filename === "blogg/index.html") {
                $(".main-content-col").append("<hr class='row featurette-divider'>");

                var archive = $("<div class='list-group'></div>");

                for (var i=0; i<metalsmith.metadata().blogposts.length; i++) {
                    var blogpost = metalsmith.metadata().blogposts[i];

                    if (i<3) {
                        var featurette = $("<div class='row featurette'></div>");
                        var textCol = $("<div class='col-md-7'></div>");
                        textCol.append($("<h2 class='featurette-heading'>" + blogpost.title + "</h2>"));
                        textCol.append($("<p class='lead'>" + blogpost.summary + "</p>"));
                        textCol.append($("<a href='/" + blogpost.url + "'><button class='btn btn-default'>LÃ¤s mer</button></a>"));
                        var imgCol = $("<div class='col-md-5'></div>");
                        imgCol.append($("<img class='img-responsive b-lazy-one-size thumbnail' src='data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==' data-src='" + blogpost.image + "' alt='" + blogpost.image_title + "' title='" + blogpost.image_alt + "'>"));

                        if (i%2) {
                            featurette.append(textCol);
                            featurette.append(imgCol);
                        } else {
                            featurette.append(imgCol);
                            featurette.append(textCol);
                        }

                        $(".main-content-col").append(featurette);

                        $(".main-content-col").append("<hr class='row featurette-divider'>");
                    }

                    archive.append($("<a class='list-group-item' href='/" + blogpost.url + "'>" + formatDateString(blogpost.date) +
                                     " - " + blogpost.title + "</a>"));
                }

                var archive
                $(".main-content-col")
                    .append($("<div class='row'></div>")
                        .append($("<div class='col-md-6'></div>")
                            .append($("<h2>Arkiv</h2>"))
                            .append(archive)));
            }

            $(".img-responsive-sizes").each(function (index) {
                var img = $(this);
                img.removeClass("img-responsive-sizes");
                img.addClass("b-lazy");

                var flickrVars = img.attr("src").split(",");

                // https://farm9.staticflickr.com/8636/16449826650_b6928018bd_q.jpg

                img.attr("src", "data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==");
                img.attr("data-src-small", "https://" + flickrVars[0] + ".staticflickr.com/" + flickrVars[1] + "/" + flickrVars[2] + "_" + flickrVars[3] + ".jpg");
                img.attr("data-src-medium", "https://" + flickrVars[0] + ".staticflickr.com/" + flickrVars[1] + "/" + flickrVars[2] + "_" + flickrVars[3] + "_b.jpg");
                img.attr("data-src-large", "https://" + flickrVars[0] + ".staticflickr.com/" + flickrVars[1] + "/" + flickrVars[2] + "_" + flickrVars[4] + "_k.jpg");
            });

            file.contents = new Buffer("<html>" + $("html").html() + "</html>");

            done();
        });
    }))
    .destination("./public")
    .build(function (err) {
        if (err) {
            console.log(err);
        }
        else {
            console.log("Metalsmith finished successfully.");
        }
    });

function formatDateString(date) {
    return date.getFullYear() + "-" + pad(date.getMonth()+1, 2) + "-" + pad(date.getDate(), 2);
}

function pad(num, size) {
    var s = "000000000" + num;
    return s.substr(s.length-size);
}
